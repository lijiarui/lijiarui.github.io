<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=https://rui.juzi.bot/warn.html">
<![endif]-->
<meta charset="utf-8">
<meta http-equiv="X-DNS-Prefetch-Control" content="on">
<link rel="dns-prefetch" href="https://rui.juzi.bot">
<link rel="dns-prefetch" href="//www.google-analytics.com">
<link rel="prefetch" href="https://rui.juzi.bot">
<link rel="prefetch" href="//www.google-analytics.com">

    <link rel="dns-prefetch" href="//disqus.com">
    <link rel="dns-prefetch" href="//lijiarui.disqus.com">
    <link rel="prefetch" href="//disqus.com">
    <link rel="prefetch" href="//lijiarui.disqus.com">


<link rel="prerender" href="https://rui.juzi.bot">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=https://rui.juzi.bot">
<meta name="author" content="Li Jiarui">
<link rel="stylesheet" href="/css/JSimple.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>如何将业务代码从puppeteer 迁移到padchat - 李佳芮de博客</title>

<meta name="keywords" content="chatbot, 聊天机器人, 人工智能, 创业">

<meta name="description " content="Wechaty 近期有了很大的升级，从0.14版本之后，开始陆续支持各类非Web 版本的解决方案。我的业务逻辑代码重度依赖于wechaty，所以自从wechaty release 了0.15 版本以后，我开始将我们的业务逻辑代码陆续从Web版本迁移到了非Web版本上来。本篇博客主要介绍了我是如何将业务逻辑代码，从Puppeteer 迁移到 Padchat上的。">

    

    
    
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="//www.googletagmanager.com/gtag/js?id=UA-114589636-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-114589636-1');
        </script>
    
    <!-- put your likes here. -->


</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="芮">芮</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/archives" title="归档"><i class="fa fa-archives"></i><span>归档</span></a>
        <a href="/tags" title="标签"><i class="fa fa-tags"></i><span>标签</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/about" title="关于本站">
            <i class="fa fa-user"></i>
            <span>关于本站</span>
        </a>
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <!-- <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a> -->
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">李佳芮の博客</h1>
        <h3 class="cover-siteTitle">时间看得见</h3>
        <p class="cover-siteDesc">一个现实的理想主义者</p>
        <div class="cover-sns">
            
    &nbsp;&nbsp;<div class="btn btn-weibo">
        <a href="https://weibo.com/u/2175505900?refer_flag=1001030101_" target="_blank" title="weibo" ref="friend">
            <i class="fa fa-weibo"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-weixin">
        <a href="https://rui.juzi.bot" target="_blank" title="weixin" ref="friend">
            <i class="fa fa-weixin"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-github">
        <a href="https://github.com/lijiarui" target="_blank" title="github" ref="friend">
            <i class="fa fa-github"></i>
        </a>
    </div>

    &nbsp;&nbsp;<div class="btn btn-telegram">
        <a href="https://www.jianshu.com/u/ac5aaa7ad293" target="_blank" title="telegram" ref="friend">
            <i class="fa fa-telegram"></i>
        </a>
    </div>


        </div>
    </div>
</div>

            <div class="page-title">
    <ul>
        <li><a href="/">最近</a></li>
        
            
                <li class>
                    <a href="/categories/chatbot" data-name="chatbot">chatbot</a>
                </li>
            
                <li class="active">
                    <a href="/categories/project" data-name="project">project</a>
                </li>
            
                <li class>
                    <a href="/categories/presentation" data-name="presentation">presentation</a>
                </li>
            
                <li class>
                    <a href="/categories/thought" data-name="thought">thought</a>
                </li>
            
                <li class>
                    <a href="/categories/reading" data-name="读书">读书</a>
                </li>
            
        
        <li class="page-search">
    <form id="search" class="search-form">
        <input type="text" readonly="readonly" id="local-search-input-tip" placeholder="读物检索">
        <button type="button" disabled="disabled" class="search-form-submit"><i class="fa fa-search"></i></button>
    </form>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                <a class="avatar fleft" href="https://www.botorange.com" target="_blank">
                    <img width="48" src="/images/avatar.jpg" alt="avatar">
                </a>
                <p><span class="label">作者</span>
                    <a href="https://blog.botorange.com" target="_blank">李佳芮</a>
                    <span title="最后编辑于&nbsp;2018-06-30">2018-06-30</span>
                </p>
                <p>一个现实的理想主义者</p>
            </div>
            <h2 class="post-title">如何将业务代码从Puppeteer 迁移到Padchat</h2>
            <div class="post-meta">
                本文共计9418个字 |
                您是第&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>位看到它们的小伙伴
            </div>
        </div>
        <div class="post-content markdown-body">
            <blockquote>
<p>Author: <a href="https://github.com/lijiarui" target="_blank" rel="noopener">@lijiarui</a> Founder of BotOrange, Author of Wechaty.</p>
</blockquote>
<p>Wechaty 近期有了很大的升级，从0.14版本之后，开始陆续支持各类非Web 版本的解决方案。我的业务逻辑代码重度依赖于wechaty，所以自从wechaty release 了0.15 版本以后，我开始将我们的业务逻辑代码陆续从Web版本迁移到了非Web版本上来。</p>
<p>本篇博客主要介绍了我是如何将业务逻辑代码，从Puppeteer 迁移到 Padchat上的。</p>
<p><img src="/img/2018/code-migration-zh.png" alt="code"></p>
<h1 id="1-Puppeteer-VS-Padchat"><a href="#1-Puppeteer-VS-Padchat" class="headerlink" title="1. Puppeteer VS Padchat"></a>1. Puppeteer VS Padchat</h1><p>首先进行一下名词解释，在说这两个名词之前，先介绍一下Puppet</p>
<p><strong>Puppet 系统</strong>是一个用来连接Wechaty API 和其他的微信实现方式的连接器。简单的来说，通过微信API进行微信自动化操作会有很多种不同的是实现方式，比如基于网页微信的实现，基于ipad协议的实现，基于ios hook 的实现，基于windows hook 的实现，基于Android xposed的实现等等。不同的实现方法代码是完全不一样的。如果没有puppet 帮助桥接不同的实现方法，开发者就会有不同的接入API，这对上层业务逻辑的开发非常不方便，因此这是Puppet 系统设计的初衷。</p>
<p>现在再来介绍Puppeteer 和 Padchat 就会比较清楚了:</p>
<p><img src="https://github.com/Chatie/wechaty/wiki/image/abstract-info.png" alt></p>
<ul>
<li>Puppeteer<br>基于网页微信的实现，通过puppet连接到Wechaty API。</li>
<li>Padchat<br>基于ipad 协议的实现，通过puppet 连接到Wechaty API。</li>
</ul>
<p>具体的Puppet 和各个实现方法，可以参考下图和这篇博客：<a href="https://blog.chatie.io/wechaty-new-release-version-0.16/" target="_blank" rel="noopener">Wechaty New Version 0.16(BETA, with super power) Released</a></p>
<h1 id="2-如何无缝切换"><a href="#2-如何无缝切换" class="headerlink" title="2. 如何无缝切换"></a>2. 如何无缝切换</h1><p>默认情况下，启动wechaty 是使用puppeteer的，切换成padchat 需要再运行的时候设置环境变量。</p>
<p>更多信息详细见wiki<a href="https://github.com/Chatie/wechaty/wiki/Puppet#2-run" target="_blank" rel="noopener">How to run a new wecahty-puppet-padchat</a></p>
<h2 id="Git-源码的方式"><a href="#Git-源码的方式" class="headerlink" title="Git 源码的方式"></a>Git 源码的方式</h2><h3 id="1-拉下github最新的代码"><a href="#1-拉下github最新的代码" class="headerlink" title="1. 拉下github最新的代码"></a>1. 拉下github最新的代码</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git pull</span><br><span class="line">rm -rf package-lock.json</span><br><span class="line">rm -rf node_modules/</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<h3 id="2-获取token并设置环境变量"><a href="#2-获取token并设置环境变量" class="headerlink" title="2. 获取token并设置环境变量"></a>2. 获取token并设置环境变量</h3><p>在<a href="https://github.com/Chatie/wechaty/issues/1296" target="_blank" rel="noopener">Wechaty v0.17 Padchat Testing: Win32/iPad/Android/iOS/API Puppets Support are comming!</a> 中进行alpha test 版本的内测报名，并获取到token： <code>WECHATY_PUPPET_PADCHAT_TOKEN</code></p>
<h3 id="3-设置环境变量并运行"><a href="#3-设置环境变量并运行" class="headerlink" title="3. 设置环境变量并运行"></a>3. 设置环境变量并运行</h3><p>记得要设置<code>WECHATY_PUPPET=padchat</code> 来切换puppet版本。<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">WECHATY_PUPPET_PADCHAT_TOKEN=your padchat token WECHATY_PUPPET=padchat  node examples/ding-dong-bot.js</span><br></pre></td></tr></table></figure></p>
<h2 id="NPM"><a href="#NPM" class="headerlink" title="NPM"></a>NPM</h2><h3 id="1-安装到最新版本的npm"><a href="#1-安装到最新版本的npm" class="headerlink" title="1. 安装到最新版本的npm"></a>1. 安装到最新版本的npm</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install wechaty@next</span><br></pre></td></tr></table></figure>
<h3 id="2-获取token并设置环境变量-1"><a href="#2-获取token并设置环境变量-1" class="headerlink" title="2. 获取token并设置环境变量"></a>2. 获取token并设置环境变量</h3><p>在<a href="https://github.com/Chatie/wechaty/issues/1296" target="_blank" rel="noopener">#1296</a> 中进行alpha test 版本的内测报名，并获取到token： <code>WECHATY_PUPPET_PADCHAT_TOKEN</code></p>
<h3 id="3-设置环境变量并运行-1"><a href="#3-设置环境变量并运行-1" class="headerlink" title="3. 设置环境变量并运行"></a>3. 设置环境变量并运行</h3><p>记得要设置<code>WECHATY_PUPPET=padchat</code> 来切换puppet版本。<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">WECHATY_PUPPET_PADCHAT_TOKEN=your padchat token WECHATY_PUPPET=padchat   node examples/ding-dong-bot.js</span><br></pre></td></tr></table></figure></p>
<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="1-拉下最新版本的docker-镜像"><a href="#1-拉下最新版本的docker-镜像" class="headerlink" title="1. 拉下最新版本的docker 镜像"></a>1. 拉下最新版本的docker 镜像</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull zixia/wechaty:latest</span><br></pre></td></tr></table></figure>
<h3 id="2-获取token"><a href="#2-获取token" class="headerlink" title="2. 获取token"></a>2. 获取token</h3><p>在<a href="https://github.com/Chatie/wechaty/issues/1296" target="_blank" rel="noopener">#1296</a> 中进行alpha test 版本的内测报名，并获取到token： <code>WECHATY_PUPPET_PADCHAT_TOKEN</code></p>
<h3 id="3-设置环境变量并运行-2"><a href="#3-设置环境变量并运行-2" class="headerlink" title="3. 设置环境变量并运行"></a>3. 设置环境变量并运行</h3><ul>
<li>记得要设置<code>WECHATY_PUPPET=padchat</code> 来切换puppet版本。</li>
<li>记得docker 版本不要重复安装wechaty 的npm 包，检查方法： 查看node_module 是否有wechaty，如果有就删掉它</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -t -i  -e WECHATY_PUPPET="padchat" -e WECHATY_PUPPET_PADCHAT_TOKEN="your token"  --volume="$(pwd)":/bot --name=wechaty zixia/wechaty:latest examples/ding-dong-bot.ts</span><br></pre></td></tr></table></figure>
<h1 id="3-代码检查"><a href="#3-代码检查" class="headerlink" title="3. 代码检查"></a>3. 代码检查</h1><p>wechaty 是使用typescript 写的，都是强类型的，我之前的代码没有统一typings，由于切换到padchat 以后，很多函数由同步变成了异步，所以索性我的代码也统一用了typings，并进行了类型检查。</p>
<p>人是一定会出错的，所以我们需要通过代码检查工具来发现代码错误、统一代码风格。我使用 <strong>TSLint</strong> 进行 TypeScript 的代码检查，编辑器用的是VSCODE。<strong>TSLint</strong> 支持自定义的代码检测规则。</p>
<h2 id="为什么需要代码检查"><a href="#为什么需要代码检查" class="headerlink" title="为什么需要代码检查"></a>为什么需要代码检查</h2><p>有人会觉得，JavaScript 非常灵活，所以需要代码检查。而 TypeScript 已经能够在编译阶段检查出很多问题了，为什么还需要代码检查呢？</p>
<p>因为 TypeScript 关注的重心是类型的匹配，而不是代码风格。当团队的人员越来越多时，同样的逻辑不同的人写出来可能会有很大的区别：</p>
<ul>
<li>缩进应该是四个空格还是两个空格？</li>
<li>是否应该禁用 var？</li>
<li>接口名是否应该以 I 开头？</li>
<li>是否应该强制使用 === 而不是 ==？</li>
<li>是否需要分号？</li>
</ul>
<p>这些问题 TypeScript 不会关注，但是却影响到多人协作开发时的效率、代码的可理解性以及可维护性。</p>
<p><a href="https://ts.xcatliu.com/engineering/lint.html" target="_blank" rel="noopener">这篇文章</a> 给了很好的例子和相关说明，有兴趣的同学可以移步去看看</p>
<p>简单的说，虽然发现代码错误比统一的代码风格更重要，但是当一个项目越来越庞大，开发人员也越来越多的时候，代码风格的约束还是必不可少的。</p>
<h2 id="使用tslint-工具代码检查"><a href="#使用tslint-工具代码检查" class="headerlink" title="使用tslint 工具代码检查"></a>使用tslint 工具代码检查</h2><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>TSLint 的使用比较简单，参考<a href="https://palantir.github.io/tslint/" target="_blank" rel="noopener">官网</a>的步骤安装到本地即可：<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install --save-dev tslint</span><br><span class="line">npm install tslint-config-standard</span><br></pre></td></tr></table></figure></p>
<h3 id="2-创建配置文件"><a href="#2-创建配置文件" class="headerlink" title="2. 创建配置文件"></a>2. 创建配置文件</h3><p>创建配置文件 <code>tslint.json</code></p>
<p>tslint 和tsconfig 建议参考wechaty 的配置：</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/blob/master/tslint.json" target="_blank" rel="noopener">tslint 配置文件</a></li>
<li><a href="https://github.com/Chatie/wechaty/blob/master/tsconfig.json" target="_blank" rel="noopener">tsconfig 配置文件</a></li>
</ul>
<p>这里针对wechaty 的一些配置进行说明</p>
<ul>
<li>“strict” : true<br>启用所有严格类型检查选项。 启用 –strict相当于启用 –noImplicitAny, –noImplicitThis, –alwaysStrict,–strictNullChecks和 –strictFunctionTypes和–strictPropertyInitialization。</li>
<li>“noEmitOnError”              : true<br>报错时不生成输出文件。</li>
<li>“noUnusedLocals”             : true<br>若有未使用的局部变量则抛错。</li>
<li>“noImplicitReturns”          : true<br>不是函数的所有返回路径都有返回值时报错。</li>
<li>“noFallthroughCasesInSwitch” : true<br>报告switch语句的fallthrough错误。（即，不允许switch的case语句贯穿）</li>
<li>“strictNullChecks”           : true<br>在严格的 null检查模式下， null和 undefined值不包含在任何类型里，只允许用它们自己和 any来赋值（有个例外， undefined可以赋值到 void）</li>
<li>“noImplicitAny”              : true<br>在表达式和声明上有隐含的 any类型时报错。 相关issue: <a href="https://github.com/Chatie/wechaty/issues/1383" target="_blank" rel="noopener">ts-node 7.0 breaking change: Skip <code>files</code> by default</a></li>
<li>“no-floating-promises”: true<br>如果有async 方法，要求必须使用await。相关issue: <a href="https://github.com/Chatie/wechaty/issues/1346" target="_blank" rel="noopener">Prevent the Floating Promise in the Async/Await Code</a></li>
<li>“noUnusedParameters”         : true<br>若有未使用的参数则抛错。</li>
<li>“noImplicitThis”             : true<br>当 this表达式的值为 any类型的时候，生成一个错误。</li>
</ul>
<p>更多参考<a href="https://tslang.cn/docs/handbook/compiler-options.html" target="_blank" rel="noopener">typescript 文档</a></p>
<h3 id="3-为-package-json-添加-tslint-脚本"><a href="#3-为-package-json-添加-tslint-脚本" class="headerlink" title="3. 为 package.json 添加 tslint 脚本"></a>3. 为 package.json 添加 tslint 脚本</h3><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">        <span class="attr">"lint"</span>: <span class="string">"tslint --project . src/**/*.ts src/**/*.tsx"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 –project . 会要求 tslint 使用当前目录的 tsconfig.json 配置来获取类型信息，很多规则需要类型信息才能生效。</p>
<p>此时执行 <code>npm run lint</code> 即可检查整个项目</p>
<h3 id="4-在-VSCode-中集成-TSLint-检查"><a href="#4-在-VSCode-中集成-TSLint-检查" class="headerlink" title="4. 在 VSCode 中集成 TSLint 检查"></a>4. 在 VSCode 中集成 TSLint 检查</h3><p>在 VSCode 中安装 <code>tslint</code> 插件即可，安装好之后，默认是开启的状态。</p>
<h3 id="5-彩蛋"><a href="#5-彩蛋" class="headerlink" title="5. 彩蛋"></a>5. 彩蛋</h3><p>唔。。。这里再赠送一个VSCode 插件彩蛋：editorconfig : 让使用不同编辑器的开发者在共同开发一个项目时“无痛”地遵循编码规范。更多说明见<a href="https://editorconfig.org/" target="_blank" rel="noopener">editorconfig官网</a> </p>
<p>wechaty 的配置见 <a href="https://github.com/Chatie/wechaty/blob/master/.editorconfig" target="_blank" rel="noopener">.editorconfig</a></p>
<h1 id="4-BREAKING-CHANGES"><a href="#4-BREAKING-CHANGES" class="headerlink" title="4. BREAKING CHANGES"></a>4. BREAKING CHANGES</h1><p>wechaty 升级版本后(参考<a href="https://blog.chatie.io/wechaty-new-release-version-0.16/" target="_blank" rel="noopener">博客</a>)，虽然尽可能的减少接口变动，但是为了适配padchat， 还是会有一些接口有了不同程度的变化。因此在进行代码迁移的时候，我们也需要修改原来的部分代码，我把相关内容列在下面了，更多内容，建议仔细阅读<a href="https://github.com/chatie/wechaty/blob/master/CHANGELOG.md" target="_blank" rel="noopener">CHANGE LOG</a></p>
<h2 id="bot-init-变成了-bot-start"><a href="#bot-init-变成了-bot-start" class="headerlink" title="bot.init() 变成了 bot.start()"></a>bot.init() 变成了 bot.start()</h2><h2 id="bot-quit-变成了-bot-stop"><a href="#bot-quit-变成了-bot-stop" class="headerlink" title="bot.quit() 变成了 bot.stop()"></a>bot.quit() 变成了 bot.stop()</h2><h2 id="FriendRequest-改成了-Friendship"><a href="#FriendRequest-改成了-Friendship" class="headerlink" title="FriendRequest 改成了 Friendship"></a>FriendRequest 改成了 Friendship</h2><p><code>FriendRequest</code> class refactored.</p>
<h3 id="之前-v0-14-或者更低"><a href="#之前-v0-14-或者更低" class="headerlink" title="之前 (v0.14 或者更低)"></a>之前 (v0.14 或者更低)</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">wechaty.on(<span class="string">'friend'</span>, <span class="function">(<span class="params">contact, request</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">    <span class="comment">// this is a friend request confirmation event</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// this is a friend request</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="之后-v0-16-或者更高"><a href="#之后-v0-16-或者更高" class="headerlink" title="之后 (v0.16 或者更高)"></a>之后 (v0.16 或者更高)</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">wechaty.on(<span class="string">'friendship'</span>, <span class="function"><span class="params">request</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (request.type()) &#123;</span><br><span class="line">    <span class="keyword">case</span> FriendRequest.Type.RECEIVE:</span><br><span class="line">      <span class="comment">// this is a friend request request</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> FriendRequest.Type.CONFIRM:</span><br><span class="line">      <span class="comment">// this is a friend request confirmation</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>建议仔细看代码<a href="https://github.com/Chatie/wechaty/blob/master/examples/friend-bot.ts" target="_blank" rel="noopener">friend-bot.ts</a></p>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1196" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 on(‘friend`) arguments changed!</a></li>
<li><a href="https://github.com/Chatie/wechaty/issues/1312" target="_blank" rel="noopener">BREAKING CHANGES v0.16: FriendRequest class will be replaced with Friendship</a></li>
</ul>
<h2 id="Message-content-改成了-Message-text"><a href="#Message-content-改成了-Message-text" class="headerlink" title="Message.content() 改成了 Message.text()"></a>Message.content() 改成了 Message.text()</h2><p>从 v0.16, Message.content() 依然是可被兼容的状态.<br>从 v0.18, Message.content() 会彻底弃用.</p>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1163" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 will replace <code>Message.content()</code> with <code>Message.text()</code></a></li>
</ul>
<h2 id="MediaMessage-将会被弃用"><a href="#MediaMessage-将会被弃用" class="headerlink" title="MediaMessage 将会被弃用"></a>MediaMessage 将会被弃用</h2><p>从 0.16, MediaMessage 依然是可被兼容的状态.<br>从 v0.18, MediaMessage 会彻底弃用.</p>
<p>未来统一使用 Message</p>
<p>代码变化<br><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- bot.say(new MediaMessage('/image.png')</span></span><br><span class="line"><span class="addition">+ bot.say(new Message('/image.png')</span></span><br></pre></td></tr></table></figure></p>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1164" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 will remove <code>MediaMessage</code> class </a></li>
</ul>
<h3 id="介绍一个好用的发送图片的功能"><a href="#介绍一个好用的发送图片的功能" class="headerlink" title="介绍一个好用的发送图片的功能"></a>介绍一个好用的发送图片的功能</h3><p>介绍一个非常好用的包: <a href="https://www.npmjs.com/package/file-box" target="_blank" rel="noopener">FileBox 官网</a>, 一个将文件数据打包方便读取的npm 包，可以轻松地在具有最少有效负载的服务器之间进行传输，而不会比其位置（本地路径，远程URL或云存储）。详细使用方法见官网。</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fileBox = FileBox.fromStream(</span><br><span class="line">fs.createReadStream(BOT_QR_CODE_IMAGE_FILE),</span><br><span class="line">BOT_QR_CODE_IMAGE_FILE,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="Wechaty-self-改成了-Wechaty-userSelf"><a href="#Wechaty-self-改成了-Wechaty-userSelf" class="headerlink" title="Wechaty.self() 改成了 Wechaty.userSelf()"></a>Wechaty.self() 改成了 Wechaty.userSelf()</h2><p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1369" target="_blank" rel="noopener">BREAKING CHANGE v0.16 Wechaty.self() eprecated, use Wechaty.userSelf() instead</a></li>
</ul>
<h2 id="Contact-personal-和-Contact-official-改成了-Contact-type"><a href="#Contact-personal-和-Contact-official-改成了-Contact-type" class="headerlink" title="Contact.personal() 和 Contact.official() 改成了 Contact.type()"></a>Contact.personal() 和 Contact.official() 改成了 Contact.type()</h2><h3 id="之前"><a href="#之前" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> isPersonal = contact.personal()</span><br><span class="line"><span class="keyword">const</span> isOfficial = contact.official()</span><br></pre></td></tr></table></figure>
<h3 id="现在"><a href="#现在" class="headerlink" title="现在"></a>现在</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the type of the Contact</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @returns ContactType - Contact.Type.PERSONAL for personal account, Contact.Type.OFFICIAL for official account</span></span><br><span class="line"><span class="comment"> * @example</span></span><br><span class="line"><span class="comment"> * const isOfficial = contact.type() === Contact.Type.OFFICIAL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">type</span> = Contact.type()</span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1366" target="_blank" rel="noopener">BREAKING CHANGE v0.16 Contact.personal() and Contact.official() deprecated, use Contact.type() instead</a></li>
</ul>
<h2 id="Room-add-返回值从Promise-变成了-Promise"><a href="#Room-add-返回值从Promise-变成了-Promise" class="headerlink" title="Room.add() 返回值从Promise 变成了 Promise"></a>Room.add() 返回值从Promise<boolean> 变成了 Promise<void></void></boolean></h2><p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1362" target="_blank" rel="noopener">BREAKING CHANGE v0.16 room.add return Promise<void> instead of return Promise<boolean> </boolean></void></a></li>
</ul>
<h2 id="Room-topic-从Sync-变成了-Async"><a href="#Room-topic-从Sync-变成了-Async" class="headerlink" title="Room.topic() 从Sync 变成了 Async"></a>Room.topic() 从Sync 变成了 Async</h2><h3 id="之前-1"><a href="#之前-1" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> topic = room.topic()</span><br></pre></td></tr></table></figure>
<h3 id="现在-1"><a href="#现在-1" class="headerlink" title="现在"></a>现在</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> topic = <span class="keyword">await</span> room.topic()</span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1295" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>Room.topic()</code> change from Sycn to Async</a></li>
</ul>
<h2 id="Room-alias-contact-从Sync-变成了-Async"><a href="#Room-alias-contact-从Sync-变成了-Async" class="headerlink" title="Room.alias(contact) 从Sync 变成了 Async"></a>Room.alias(contact) 从Sync 变成了 Async</h2><h3 id="之前-2"><a href="#之前-2" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> alias = room.alias(contact)</span><br></pre></td></tr></table></figure>
<h3 id="现在-2"><a href="#现在-2" class="headerlink" title="现在"></a>现在</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> alias = <span class="keyword">await</span> room.alias(contact)</span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1293" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>Room.alias(contact)</code> change from Sycn to Async</a></li>
</ul>
<h2 id="Room-memberList-从Sync-变成了-Async"><a href="#Room-memberList-从Sync-变成了-Async" class="headerlink" title="Room.memberList() 从Sync 变成了 Async"></a>Room.memberList() 从Sync 变成了 Async</h2><h3 id="之前-3"><a href="#之前-3" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> memberList = room.memberList()</span><br></pre></td></tr></table></figure>
<h3 id="现在-3"><a href="#现在-3" class="headerlink" title="现在"></a>现在</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> memberList = <span class="keyword">await</span> room.memberList()</span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1290" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>Room.memberList()</code> change from Sycn to Async</a></li>
</ul>
<h2 id="Room-member-从Sync-变成了-Async"><a href="#Room-member-从Sync-变成了-Async" class="headerlink" title="Room.member() 从Sync 变成了 Async"></a>Room.member() 从Sync 变成了 Async</h2><h3 id="之前-4"><a href="#之前-4" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> contact = room.member(<span class="string">'Huan'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="现在-4"><a href="#现在-4" class="headerlink" title="现在"></a>现在</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- const contact = room.member('Huan')</span></span><br><span class="line"><span class="addition">+ const contact = await room.member('Huan')</span></span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1258" target="_blank" rel="noopener">BREAKING CHANGES: v0.16 <code>Room.member()</code> from <code>sync</code> to <code>async</code></a></li>
</ul>
<h2 id="Room-has-contact-从Sync-变成了-Async"><a href="#Room-has-contact-从Sync-变成了-Async" class="headerlink" title="Room.has(contact) 从Sync 变成了 Async"></a>Room.has(contact) 从Sync 变成了 Async</h2><h3 id="之前-5"><a href="#之前-5" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> exist = room.has(contact)</span><br></pre></td></tr></table></figure>
<h3 id="现在-5"><a href="#现在-5" class="headerlink" title="现在"></a>现在</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> exist = <span class="keyword">await</span> room.has(contact)</span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1289" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>Room.has(contact)</code> change from Sycn to Async</a></li>
</ul>
<h2 id="Message-mention-从Sync-变成了-Async"><a href="#Message-mention-从Sync-变成了-Async" class="headerlink" title="Message.mention() 从Sync 变成了 Async"></a>Message.mention() 从Sync 变成了 Async</h2><h3 id="之前-6"><a href="#之前-6" class="headerlink" title="之前"></a>之前</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mentionList = message.mention()</span><br></pre></td></tr></table></figure>
<h3 id="之后"><a href="#之后" class="headerlink" title="之后"></a>之后</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- const mentionList = message.mention()</span></span><br><span class="line"><span class="addition">+ const mentionList = await message.mention()</span></span><br></pre></td></tr></table></figure>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1259" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>Message.mention()</code> change from <code>sync</code> to <code>async</code></a></li>
</ul>
<h2 id="scan-事件参数发生了变化"><a href="#scan-事件参数发生了变化" class="headerlink" title="scan 事件参数发生了变化"></a><code>scan</code> 事件参数发生了变化</h2><p>对老代码是兼容的</p>
<h3 id="之前-7"><a href="#之前-7" class="headerlink" title="之前"></a>之前</h3><p><a href="https://github.com/Chatie/wechaty/blob/860e85ec776ac20e92751ec4b67e0d539ef40a16/examples/ding-dong-bot.ts#L74-L77" target="_blank" rel="noopener">https://github.com/Chatie/wechaty/blob/860e85ec776ac20e92751ec4b67e0d539ef40a16/examples/ding-dong-bot.ts#L74-L77</a></p>
<h3 id="之后-1"><a href="#之后-1" class="headerlink" title="之后"></a>之后</h3><p><a href="https://github.com/Chatie/wechaty/blob/07008dff17ccc46b347ba28b85af167984573ea0/examples/ding-dong-bot.ts#L74-L76" target="_blank" rel="noopener">https://github.com/Chatie/wechaty/blob/07008dff17ccc46b347ba28b85af167984573ea0/examples/ding-dong-bot.ts#L74-L76</a></p>
<p>请注意我们删除了 <del><code>const loginUrl = url.replace(/\/qrcode\//, &#39;/l/&#39;)</code></del></p>
<p>相关issue:</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1262" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 <code>scan</code> event args will be different!</a></li>
</ul>
<h2 id="Room-Contact-Message-FriendRequest在不能直接实例化"><a href="#Room-Contact-Message-FriendRequest在不能直接实例化" class="headerlink" title="Room,Contact,Message,FriendRequest在不能直接实例化"></a><code>Room</code>,<code>Contact</code>,<code>Message</code>,<code>FriendRequest</code>在不能直接实例化</h2><h3 id="相关错误信息"><a href="#相关错误信息" class="headerlink" title="相关错误信息"></a>相关错误信息</h3><ol>
<li>Error: class can not be instanciated directly!</li>
<li>Error: must not use the global Message/Contact/Room. use a cloned child via cloneClass instead</li>
</ol>
<p>由于 <code>Contact</code>, <code>FriendRequest</code>, <code>Message</code>, 和 <code>Room</code> 这些类要和 <code>Puppet</code> 绑定，所以这些类不能直接实例化</p>
<p>他们需要先有一个 <code>cloneClass()</code>, 然后才能和<code>Puppet</code> 绑定, 之后才能像下面一样使用:</p>
<ol>
<li><code>wechaty.Contact</code>, or</li>
<li><code>puppet.Contact</code>, etc.</li>
</ol>
<h3 id="错误的做法"><a href="#错误的做法" class="headerlink" title="~错误的做法~"></a><del>~错误的做法</del>~</h3><figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Room &#125; <span class="keyword">from</span> <span class="string">'wechaty'</span></span><br><span class="line"><span class="keyword">const</span> room = <span class="keyword">await</span> Room.create(...)</span><br></pre></td></tr></table></figure>
<p>上面的代码出出错</p>
<h3 id="正确的做法"><a href="#正确的做法" class="headerlink" title="正确的做法"></a>正确的做法</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- import &#123; Room &#125; from 'wechaty'</span></span><br><span class="line"><span class="addition">+ import &#123; Wechaty &#125; from 'wechaty'</span></span><br><span class="line"></span><br><span class="line"><span class="deletion">- const room = await Room.create(...)</span></span><br><span class="line"><span class="addition">+ const wechaty = new Wechaty()</span></span><br><span class="line"><span class="addition">+ const room = await wechaty.Room.create(...)</span></span><br></pre></td></tr></table></figure>
<p>Contact, FriendRequest, and Message这些也一样</p>
<p>Related Link</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1217" target="_blank" rel="noopener">Error: class can not be instanciated directly! </a></li>
<li><a href="https://github.com/Chatie/wechaty/issues/1364" target="_blank" rel="noopener">BREAKING CHANGE v0.16 Contact, FriendRequest, Message, and Room classes will not be able to instantiate directly</a></li>
<li><a href="https://github.com/Chatie/wechaty/issues/1161" target="_blank" rel="noopener">Error: static puppet not found</a></li>
<li><a href="https://github.com/Chatie/wechaty/issues/518" target="_blank" rel="noopener">Wechaty Multi-Instance Suport</a></li>
<li>NPM <a href="https://www.npmjs.com/package/clone-class" target="_blank" rel="noopener">clone-class</a></li>
<li><a href="https://github.com/zixia/node-clone-class/issues/5" target="_blank" rel="noopener">https://github.com/zixia/node-clone-class/issues/5</a></li>
</ul>
<h2 id="Message-ext-返回-ext-而不是-ext"><a href="#Message-ext-返回-ext-而不是-ext" class="headerlink" title="Message.ext() 返回 .ext 而不是 ext"></a>Message.ext() 返回 <code>.ext</code> 而不是 <code>ext</code></h2><p>根据<code>ext()</code> 在 Node/Python/C# 中的实现，我们的 <code>ext()</code> 也返回包括<code>.</code>的文件扩展名。 所以更新如下：</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ext = message.ext()</span><br><span class="line"><span class="comment">// assume the filename is `test.txt`</span></span><br></pre></td></tr></table></figure>
<h3 id="之前-v0-14-或更早"><a href="#之前-v0-14-或更早" class="headerlink" title="之前 (v0.14 或更早)"></a>之前 (v0.14 或更早)</h3><p><code>assert(ext === &#39;txt&#39;)</code></p>
<h3 id="现在-v0-16-或之后"><a href="#现在-v0-16-或之后" class="headerlink" title="现在 (v0.16 或之后)"></a>现在 (v0.16 或之后)</h3><p><code>assert(ext === &#39;.txt&#39;)</code></p>
<p>相关链接</p>
<ul>
<li><a href="https://github.com/Chatie/wechaty/issues/1168" target="_blank" rel="noopener">BREAKING CHANGE: v0.16 Message.ext() return ‘.ext’ instead of ‘ext’ before</a></li>
</ul>
<p>嗯，这大概就是所有的迁移记录了，谢谢！希望大家使用顺利！</p>

        </div>
        <div class="post-tool">
            <a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">
                <i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏
            </a>
        </div>
        
        <div class="post-tags">标签：
            
            <a href="/tags/wechaty/">wechaty</a>
            
            <a href="/tags/wechaty-puppet-padchat/">wechaty-puppet-padchat</a>
            
        </div>
        
    </article>
    
    <p style="text-align: center">本文代表个人观点，内容仅供参考。若有不恰当之处，望不吝赐教！</p>
    
    
    
    
        <div class="adsense_post_left">
            
    <ins class="adsbygoogle" style="display:inline-block;width:160px;height:600px" data-ad-client data-ad-slot></ins>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
        <div class="adsense_post_right">
            
    <ins class="adsbygoogle" style="display:inline-block;width:160px;height:600px" data-ad-client data-ad-slot></ins>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </div>
        <p>
            
    <ins class="adsbygoogle" style="display:block" data-ad-client data-ad-slot data-ad-format="auto" data-full-width-responsive="true"></ins>

<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script>

        </p>
    


    
    
        <div id="disqus_thread"></div>
        <script>
            /**
             *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
             *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
             */
            var disqus_config = function () {
                this.page.url = 'https://rui.juzi.bot/project/2018-06-24-migrating-wechaty-v0.14-to-v0.18-guide-from-puppeteer-to-padchat-zh.html';
                this.page.identifier = 'project/2018-06-24-migrating-wechaty-v0.14-to-v0.18-guide-from-puppeteer-to-padchat-zh.html';
            };
            (function () { // DON'T EDIT BELOW THIS LINE
                var d = document, disqus_shortname = 'lijiarui', s = d.createElement('script');
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    


</div>
<script src="/js/busuanzi.pure.mini.js"></script>


        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner" style="text-align: center">
        <p>
            <a href="/about" title="关于">关于</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!-- 自定义链接 -->
            <a href="/help" title="帮助">帮助</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/links" title="友链">友链</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <a href="/sitemap.xml" title="地图">地图</a>
        </p>
        <p>
            本站已建立&nbsp<a href="/timeline" id="siteBuildingTime"></a>&nbsp天，<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="licence">采用知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议创作</a><br>
            ©2017-<span id="cpYear"></span> 基于&nbsp<a href="http://hexo.io" target="_blank" rel="nofollow">Hexo</a>
            ，主题采用&nbsp&nbsp<a href="https://github.com/tangkunyin/hexo-theme-jsimple" target="_blank" rel="bookmark">JSimple</a>
            ，作者&nbsp<a href="https://rui.juzi.bot" target="_blank" rel="friend">李佳芮</a>
            ，Hosted by <a href="https://pages.github.com/" target="_blank" rel="nofollow">GitHub Pages</a>
        </p>
    </div>
</footer>
<script src="/js/SimpleCore.js"></script>

</div>
<!-- search pop -->
<div class="popup search-popup local-search-popup">
    <div class="local-search-header clearfix">
        <span class="search-icon">
            <i class="fa fa-search"></i>
        </span>
        <span class="popup-btn-close">
            <i class="fa fa-times-circle"></i>
        </span>
        <div class="local-search-input-wrapper">
            <input id="local-search-input" spellcheck="false" type="text" autocomplete="off" placeholder="请输入查询关键词">
        </div>
    </div>
    <div id="local-search-result"></div>
</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        SimpleCore.init({
            buildingTime: '01/20/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
            localSearch: {
                dbPath: '/search.xml',
                trigger: 'auto',
                topN: '1',
                unescape: 'false'
            }
        });
    });
</script>
</body>
</html>
